{% extends 'base.html.twig' %}

{% block title %}Tennis Player & Court Availability{% endblock %}
{% block body %}

    <h1 style="color: red">Tennis Player & Court Availability</h1>
    {% for message in app.flashes('emailNotify') %}
        <div id="emailNotify" data-email="{{ message }}">
        </div>
    {% endfor %}
    <div id="modal" class=" bg-success text-white border rounded">
        <div id="message-container" class="m-auto">hello</div>
    </div>


    <div class="row">
        <div class="col-md-7">
            {% if minDate == today|date('Y-m-d') %}
                <a class="btn btn-primary btn-sm mt-2"
                   href="{{ path('tennis_player_and_courtavailability_index', {'minDate': today|date('Y-m-d'), 'maxDate': nextSunday|date('Y-m-d')}) }}">This
                    week </a>
            {% else %}
                <a class="btn btn-outline-primary btn-sm mt-2"
                   href="{{ path('tennis_player_and_courtavailability_index', {'minDate': today|date('Y-m-d'), 'maxDate': nextSunday|date('Y-m-d')}) }}">This
                    week</a>
            {% endif %}


            {% if minDate == monday2|date('Y-m-d') %}
                <a class="btn btn-primary btn-sm mt-2"
                   href="{{ path('tennis_player_and_courtavailability_index', {'minDate': monday2|date('Y-m-d'), 'maxDate': sunday2|date('Y-m-d')}) }}">Next
                    week</a>
            {% else %}
                <a class="btn btn-outline-primary btn-sm mt-2"
                   href="{{ path('tennis_player_and_courtavailability_index', {'minDate': monday2|date('Y-m-d'), 'maxDate': sunday2|date('Y-m-d')}) }}">Next
                    week</a>
            {% endif %}


            {% if minDate == monday3|date('Y-m-d') %}
                <a class="btn btn-primary btn-sm mt-2"
                   href="{{ path('tennis_player_and_courtavailability_index', {'minDate': monday3|date('Y-m-d'), 'maxDate': sunday3|date('Y-m-d')}) }}">Following
                    week</a>
            {% else %}
                <a class="btn btn-outline-primary btn-sm mt-2"
                   href="{{ path('tennis_player_and_courtavailability_index', {'minDate': monday3|date('Y-m-d'), 'maxDate': sunday3|date('Y-m-d')}) }}">Following
                    week</a>
            {% endif %}
        </div>
        <div class="col-md-1">
            <a target="_blank" href="{{ path('instructionsTennis') }}"><i
                        style="font-size: 25px; color: red; background-color: yellow"
                        class="fas fa-info-circle"></i></a>
        </div>
        <div class="col-md-4">
            {% if minDate is null %}
                <strong>Date range: </strong> {{ lastMonday |date('d-M-Y') }} - {{ nextSunday |date('d-M-Y') }}
            {% else %}
                <strong>Date range: </strong>  {{ minDate|date('d-M-Y') }} - {{ maxDate|date('d-M-Y') }}
            {% endif %}
        </div>
    </div>

    <hr>

    {% for date in dates %}
        <h3 style="color: blue;">{{ date.date |date('D d-M-Y') }}</h3>

        <table class="table">

            <thead>
            <tr>
                <th style="text-align: right">Hour</th>
                <th style="text-align: left">Court(s) Available</th>
                <th style="text-align: right">Court Available & Match criteria for 2+</th>
                {% for tennis_player in tennis_players %}
                    {% for matchrole in tennis_player.roles %}
                        {% if matchrole == 'ROLE_TENNIS_PLAYER' %}
                            <th title={{ tennis_player.email }};{{ tennis_player.mobile }}>
                                <a target="_blank"
                                   href= {{ path('user_edit', {'id': tennis_player.id}) }}> {{ tennis_player.fullName }}</a>
                                {% if is_granted ('ROLE_SUPER_ADMIN') %} ({{ tennis_player.tennisRank }})
                                {% endif %}
                                <br>
                                <a href="mailto:{{ tennis_player.email }}"><i class="fa fa-envelope"
                                                                              style="color:#d7cccc;font-size:16px ; text-align: center"></i></a>
                                <a href="https://wa.me/{{ tennis_player.mobile }}"> <i class="fa fa-whatsapp"
                                                                                       style="color:green; text-align: center"></i></a>
                            </th>
                        {% endif %}
                    {% endfor %}

                {% endfor %}
            </tr>
            </thead>

            <tbody>
            {% for hour in hours %}
                {% set i = hour.sort %}
                {% set tennis_court_availability_id = '' %}
                <tr>

                    <td style="text-align: right" data-sort="{{ hour.sort }}"><b>{{ hour.hour }}</b></td>

                    <td style="text-align:left">
                        {% set flag = 0 %}
                        {% for tennis_court_availability in tennis_court_availabilities %}
                            {% if  tennis_court_availability.hour == hour.sort and tennis_court_availability.date|date('Y-m-d') == date.date|date('Y-m-d') %}
                                {% if tennis_court_availability.available|first == '£' or tennis_court_availability.available == 1 %}
                                    {{ tennis_court_availability.venue.venue }} ({{ tennis_court_availability.available }})
                                    <br>
                                {% endif %}
                            {% endif %}
                        {% endfor %}
                    </td>


                    <td style="text-align:left">

                        {% set flag = 0 %}

                        {% for tennis_court_availability in tennis_court_availabilities %}
                            {% set playerContainer = [] %}
                            {% set playerContainer1= [] %}
                            {% set tennis_court_availability_id = tennis_court_availability.id %}
                            {% if  tennis_court_availability.hour == hour.sort and tennis_court_availability.date|date('Y-m-d') == date.date|date('Y-m-d') %}
                                {% if tennis_court_availability.available|first=='£'or tennis_court_availability.available == 1 %}

                                    {% for tennis_player_availability in tennis_player_availabilities %}

                                        {% for tennis_court_preference in tennis_court_preferences %}

                                            {% if date.date|date('l')  == 'Saturday' or date.date|date('l') == 'Sunday' %}

                                                {% if tennis_player_availability.hour == hour.sort and
                                                    tennis_player_availability.date|date('Y-m-d') == date.date|date('Y-m-d') and
                                                    tennis_player_availability.available=='1' and
                                                    tennis_court_preference.user.id == tennis_player_availability.user.id and
                                                    tennis_court_preference.tennisVenue.id == tennis_court_availability.venue.id and
                                                    tennis_court_preference.weekendElection == 1 %}
                                                    {{ tennis_player_availability.user.fullName }};
                                                    {% set playerContainer1 = playerContainer1|merge({(0~tennis_player_availability.user.tennisRankScore):tennis_player_availability.user.id}) %}
                                                    {% set playerContainer = playerContainer|merge({(0~tennis_player_availability.user.id):tennis_player_availability.user.tennisRankScore}) %}
                                                {% endif %}
                                            {% else %}
                                                {% if tennis_player_availability.hour == hour.sort and
                                                    tennis_player_availability.date|date('Y-m-d') == date.date|date('Y-m-d') and
                                                    tennis_player_availability.available=='1' and
                                                    tennis_court_preference.user.id == tennis_player_availability.user.id and
                                                    tennis_court_preference.tennisVenue.id == tennis_court_availability.venue.id and
                                                    tennis_court_preference.weekdayElection == 1 %}
                                                    {{ tennis_player_availability.user.fullName }};
                                                    {% set playerContainer1 = playerContainer1|merge({(0~tennis_player_availability.user.tennisRank):tennis_player_availability.user.id}) %}
                                                    {% set playerContainer = playerContainer|merge({(0~tennis_player_availability.user.id):tennis_player_availability.user.tennisRank}) %}
                                                {% endif %}

                                            {% endif %}

                                        {% endfor %}
                                    {% endfor %}
                                    {% if tennis_court_availability.courtBooked ==1 %} Booked
                                    {% else %}
                                        {% set myArray=[] %}
                                        {% for player in playerContainer|sort %}
                                            {% set myArray = myArray|merge([player]) %}
                                        {% endfor %}

                                        {% if playerContainer|length == 2 %}

                                            <a class="btn btn-outline-success"
                                               href="{{ path('tennis_player_availability_book_and_email',{'tennis_court_availability_id': tennis_court_availability_id, 'player1':playerContainer1['0'~myArray[0]], 'player2':playerContainer1['0'~myArray[1]]  }) }}">Book
                                                and Email</a>
                                        {% elseif playerContainer|length==3 %}
                                            <a class="btn btn-outline-success"
                                               href="{{ path('tennis_player_availability_book_and_email',{'tennis_court_availability_id': tennis_court_availability_id, 'player1':playerContainer1['0'~myArray[0]], 'player2':playerContainer1['0'~myArray[1]], 'player3' :playerContainer1['0'~myArray[2]] }) }}">Book
                                                and Email</a>
                                        {% elseif playerContainer|length>=4 %}
                                            <a class="btn btn-outline-success"
                                               href="{{ path('tennis_player_availability_book_and_email',{'tennis_court_availability_id': tennis_court_availability_id, 'player1':playerContainer1['0'~myArray[0]], 'player2': playerContainer1['0'~myArray[1]], 'player3':playerContainer1['0'~myArray[2]], 'player4':playerContainer1['0'~myArray[3]] }) }}">Book
                                                and Email</a>
                                        {% endif %}
                                    {% endif %}
                                    {% set playerContainer = [] %}
                                    <br>
                                {% endif %}
                            {% endif %}
                        {% endfor %}

                    </td>

                    {% for tennis_player in tennis_players %}
                        {% for matchrole in tennis_player.roles %}
                            {% if matchrole == 'ROLE_TENNIS_PLAYER' %}
                                {% set availability = '' %}
                                {% set id = 0 %}

                                <td style="text-align: center">
                                    {% for tennis_player_availability in tennis_player_availabilities %}
                                        {% if tennis_player_availability.date|date('Y-m-d') == date.date|date('Y-m-d') and
                                            tennis_player_availability.hour == i and
                                            tennis_player_availability.user.id == tennis_player.id %}
                                            {% set flag = 1 %}
                                            {% set availability = tennis_player_availability.available %}
                                            {% set id = tennis_player_availability.id %}
                                        {% endif %}
                                    {% endfor %}

                                    {% if is_granted('ROLE_SUPER_ADMIN') or tennis_player.id ==app.user.id %}


                                        {% if availability == 1 or availability == 0 %}

                                            {% if availability == 1 %}
                                                <a href={{ path('tennis_player_availability_edit', {'id' : id, 'available':availability}) }}><i
                                                            class="fa fa-circle"
                                                            style="color: green; text-align: right"></i></a>
                                            {% else %}
                                                <a href={{ path('tennis_player_availability_edit', {'id' : id, 'available':availability} ) }}><i
                                                            class="fa fa-circle" style="color: red"></i> </a>
                                            {% endif %}
                                        {% else %}
                                            <a href={{ path('tennis_player_availability_add', {'hour': i, 'date': date.date |date('Y-m-d') , 'player' : tennis_player.id}) }}><i
                                                        class="fa fa-circle"
                                                        style="color: orange; text-align: right"></i></a>
                                        {% endif %}


                                    {% else %}
                                        {% if availability == 1 or availability == 0 %}

                                            {% if availability == 1 %}
                                                <i class="fa fa-circle" style="color: green; text-align: right"></i>
                                            {% else %}
                                                <i class="fa fa-circle" style="color: red"></i>
                                            {% endif %}
                                        {% else %}
                                            <i class="fa fa-circle" style="color: orange; text-align: right"></i>
                                        {% endif %}
                                    {% endif %}

                                </td>
                            {% endif %}
                        {% endfor %}
                    {% endfor %}


                </tr>
            {% endfor %}
            </tbody>
        </table>
        <br>
        <hr>
    {% endfor %}


    {% if is_granted('ROLE_SUPER_ADMIN') %}
        <a class="btn btn-outline-primary btn-sm mt-2" href="{{ path('tennis_player_availability_new') }}">New tennis
            player availability</a> <br>
    {% endif %}
    <br>

{% endblock %}


{% block datatable %}
    <script>
        $(document).ready(function () {
            var notify = $('#emailNotify').attr('data-email');
            if (notify) {

                //alert(notify);
                $('#message-container').html(notify);
                $('#modal').css('display', 'flex');


                setTimeout(function () {
                    $('#modal').hide();
                }, 8000);
            }
        });


        $(document).ready(function () {
            $('.table').DataTable({
                'pageLength': 50,
                "order": [[0, 'asc']],
                "paging": false,
                "searching": false,
                "bInfo": false
            });


        });
    </script>
{% endblock datatable %}
